# ============================================================================
# Prometheus Configuration for Phase 8 Week 2 Webhook Delivery System
# ============================================================================
# Purpose: Collect and aggregate metrics from webhook worker services
# Metrics: Delivery rates, latency, queue depth, worker health, circuit breaker
# Date: 2025-12-27
# ============================================================================

# Global settings applied to all scrape configs
global:
  # Default: scrape targets every 15 seconds
  scrape_interval: 15s

  # Default: evaluate alert rules every 15 seconds
  evaluation_interval: 15s

  # Add external labels to all time series
  external_labels:
    cluster: 'local-dev'
    environment: 'development'
    service: 'pggit-webhook'

# ============================================================================
# Alerting Configuration
# ============================================================================
# Set up alert rules and how to route alerts to alertmanagers
alerting:
  alertmanagers:
    # Uncomment when alertmanager is configured
    # - static_configs:
    #     - targets: ['localhost:9093']

# Load alert rules from file
rule_files:
  # Uncomment when alerts are ready to use
  # - 'prometheus/webhook_alerts.yml'

# ============================================================================
# Scrape Configurations
# ============================================================================

scrape_configs:
  # ========================================================================
  # Prometheus Self-Monitoring
  # ========================================================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # ========================================================================
  # Webhook Worker 1 Metrics
  # ========================================================================
  # Scrapes Prometheus metrics exposed on port 8000
  - job_name: 'webhook-worker-1'
    scrape_interval: 10s        # Scrape more frequently for real-time updates
    scrape_timeout: 5s          # Timeout after 5 seconds
    metrics_path: '/metrics'    # Default Prometheus metrics endpoint

    static_configs:
      - targets: ['localhost:8000']
        labels:
          worker_id: 'worker-1'
          service: 'webhook-delivery'
          instance: 'pggit-worker-1'

    # Relabel metrics to add custom labels
    metric_relabel_configs:
      # Add service label to all metrics
      - source_labels: [__name__]
        regex: '.*'
        action: replace
        target_label: service
        replacement: 'webhook-delivery'

  # ========================================================================
  # Webhook Worker 2 Metrics
  # ========================================================================
  # Scrapes Prometheus metrics exposed on port 8001
  - job_name: 'webhook-worker-2'
    scrape_interval: 10s
    scrape_timeout: 5s
    metrics_path: '/metrics'

    static_configs:
      - targets: ['localhost:8001']
        labels:
          worker_id: 'worker-2'
          service: 'webhook-delivery'
          instance: 'pggit-worker-2'

    metric_relabel_configs:
      - source_labels: [__name__]
        regex: '.*'
        action: replace
        target_label: service
        replacement: 'webhook-delivery'

  # ========================================================================
  # Webhook Worker 3 Metrics
  # ========================================================================
  # Scrapes Prometheus metrics exposed on port 8002
  - job_name: 'webhook-worker-3'
    scrape_interval: 10s
    scrape_timeout: 5s
    metrics_path: '/metrics'

    static_configs:
      - targets: ['localhost:8002']
        labels:
          worker_id: 'worker-3'
          service: 'webhook-delivery'
          instance: 'pggit-worker-3'

    metric_relabel_configs:
      - source_labels: [__name__]
        regex: '.*'
        action: replace
        target_label: service
        replacement: 'webhook-delivery'

  # ========================================================================
  # PostgreSQL Exporter (Optional - when pg_exporter is available)
  # ========================================================================
  # Uncomment to enable PostgreSQL metrics collection
  # Requires postgres_exporter running on port 9187
  # Download: https://github.com/prometheus-community/postgres_exporter
  #
  # - job_name: 'postgres'
  #   scrape_interval: 30s
  #   scrape_timeout: 10s
  #   static_configs:
  #     - targets: ['localhost:9187']
  #       labels:
  #         service: 'pggit-database'
  #         instance: 'postgres-1'
  #   metric_relabel_configs:
  #     # Keep only webhook-related metrics
  #     - source_labels: [__name__]
  #       regex: 'pg_stat_statements.*'
  #       action: keep

  # ========================================================================
  # Custom Metrics Endpoint (Optional - for custom applications)
  # ========================================================================
  # If you have custom applications exporting metrics on port 9100
  # - job_name: 'custom-app'
  #   static_configs:
  #     - targets: ['localhost:9100']
  #       labels:
  #         service: 'custom-service'

# ============================================================================
# Remote Storage Configuration (Optional)
# ============================================================================
# Uncomment to send metrics to external systems (Datadog, New Relic, etc.)
#
# remote_write:
#   - url: https://api.datadoghq.com/api/v1/series
#     write_relabel_configs:
#       - source_labels: [__name__]
#         regex: 'webhook_.*'
#         action: keep
#     bearer_token: YOUR_API_KEY

# ============================================================================
# Storage Configuration
# ============================================================================
# Note: These are set via command line when running Prometheus
# storage:
#   tsdb:
#     path: /var/lib/prometheus    # Where to store metrics database
#     retention:
#       time: 30d                  # Keep metrics for 30 days
#       size: 50GB                 # Or until 50GB is reached

