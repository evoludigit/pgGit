name: Minimal Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v6
    
    - name: Debug - List files
      run: |
        echo "=== Current directory ==="
        pwd
        echo "=== Files in sql directory ==="
        ls -la sql/
        echo "=== Test files ==="
        ls -la tests/test-*.sql | head -10
    
    - name: Test PostgreSQL connection
      env:
        PGPASSWORD: postgres
      run: |
        psql -h localhost -U postgres -d test_db -c "SELECT version();"
        psql -h localhost -U postgres -d test_db -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
    
    - name: Install full pgGit
      env:
        PGPASSWORD: postgres
      run: |
        echo "Installing pgGit using install.sql..."
        cd sql
        if psql -h localhost -U postgres -d test_db -f install.sql; then
          echo "✓ pgGit installed successfully"
        else
          echo "✗ pgGit installation failed"
          exit 1
        fi

    - name: Verify installation
      env:
        PGPASSWORD: postgres
      run: |
        echo "Verifying pgGit installation..."
        psql -h localhost -U postgres -d test_db << 'EOF'
        -- Show pgGit version
        SELECT 'pgGit Version: ' || pggit.version() as version_info;

        -- Count tables in pggit schema
        SELECT 'Tables in pggit schema: ' || count(*)::text
        FROM information_schema.tables
        WHERE table_schema = 'pggit';

        -- Count functions in pggit schema
        SELECT 'Functions in pggit schema: ' || count(*)::text
        FROM pg_proc
        WHERE pronamespace = 'pggit'::regnamespace;

        SELECT '✓ Installation verified successfully' as status;
        EOF