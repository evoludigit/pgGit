name: Debug Test

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  debug:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v6
    
    - name: Test basic connection
      env:
        PGPASSWORD: postgres
      run: |
        echo "Testing connection..."
        psql -h localhost -U postgres -d test_db -c "SELECT version();"
        
    - name: Try minimal install
      env:
        PGPASSWORD: postgres
      run: |
        echo "Creating schema..."
        psql -h localhost -U postgres -d test_db << 'EOF'
        CREATE SCHEMA IF NOT EXISTS pggit;
        CREATE EXTENSION IF NOT EXISTS pgcrypto;
        
        -- Test table creation
        CREATE TABLE pggit.test (id serial PRIMARY KEY);
        SELECT 'Basic setup works' as status;
        EOF
        
    - name: Install pgGit using install.sql
      env:
        PGPASSWORD: postgres
      run: |
        cd sql
        echo "Installing pgGit core..."
        if psql -h localhost -U postgres -d test_db -f install.sql; then
          echo "✓ pgGit core installed successfully"
          psql -h localhost -U postgres -d test_db -c "SELECT 'pgGit version: ' || pggit.version();"
        else
          echo "✗ pgGit installation FAILED"
          exit 1
        fi

    - name: Verify all modules loaded
      env:
        PGPASSWORD: postgres
      run: |
        echo "Verifying pgGit installation..."
        psql -h localhost -U postgres -d test_db << 'EOF'
        -- Verify core tables exist
        SELECT 'Checking core tables...' as check;
        SELECT count(*) as table_count FROM information_schema.tables
        WHERE table_schema = 'pggit';

        -- List some core functions
        SELECT 'Core functions available:' as check;
        SELECT proname FROM pg_proc
        WHERE pronamespace = 'pggit'::regnamespace
        LIMIT 10;
        EOF