name: Build Packages

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg-version: [15, 16, 17]

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y debhelper postgresql-server-dev-${{ matrix.pg-version }}

    - name: Build package
      run: |
        dpkg-buildpackage -us -uc -b

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: postgresql-${{ matrix.pg-version }}-pggit
        path: ../postgresql-${{ matrix.pg-version }}-pggit_*.deb

    - name: Upload to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ../postgresql-${{ matrix.pg-version }}-pggit_${{ github.event.release.tag_name }}.deb
        asset_name: postgresql-${{ matrix.pg-version }}-pggit_${{ github.event.release.tag_name }}.deb
        asset_content_type: application/vnd.debian.binary-package

  build-rpm:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y rpm

    - name: Build RPM
      run: |
        # Setup RPM build environment
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

        # Create source tarball
        git archive --format=tar.gz --prefix=pggit-${{ github.event.release.tag_name }}/ HEAD > ~/rpmbuild/SOURCES/pggit-${{ github.event.release.tag_name }}.tar.gz

        # Copy spec file
        cp packaging/rpm/pggit.spec ~/rpmbuild/SPECS/

        # Build RPM
        rpmbuild -ba ~/rpmbuild/SPECS/pggit.spec

        # Copy to workspace
        cp ~/rpmbuild/RPMS/x86_64/pggit-${{ github.event.release.tag_name }}-*.rpm .

    - name: Upload RPM artifact
      uses: actions/upload-artifact@v3
      with:
        name: pggit-rpm
        path: pggit-*.rpm

    - name: Upload RPM to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: pggit-${{ github.event.release.tag_name }}-*.rpm
        asset_name: pggit-${{ github.event.release.tag_name }}.rpm
        asset_content_type: application/x-rpm