---
name: Mutation Testing

on:
  schedule:
    # Weekly on Sundays at 4 AM UTC (after chaos tests)
    - cron: '0 4 * * 0'
  workflow_dispatch:
    inputs:
      test_subset:
        description: 'Test subset to mutate'
        required: false
        default: 'e2e'
        type: choice
        options:
          - e2e
          - chaos
          - all

jobs:
  mutation-test:
    name: Mutation Testing - ${{ matrix.test-subset }}
    runs-on: ubuntu-latest
    continue-on-error: true  # Mutation testing is exploratory

    strategy:
      fail-fast: false
      matrix:
        test-subset: [e2e]  # Can add 'chaos' for more comprehensive testing

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pggit_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[chaos]"
          pip install mutmut

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Install pgGit
        env:
          PGPASSWORD: postgres
          PGHOST: localhost
          PGUSER: postgres
          PGDATABASE: pggit_test
        run: |
          cd sql
          psql -f install.sql
          cd ..

      - name: Run mutation testing
        id: mutmut
        continue-on-error: true
        env:
          PGPASSWORD: postgres
          PGHOST: localhost
          PGUSER: postgres
          PGDATABASE: pggit_test
        run: |
          # Determine paths to mutate based on test subset
          if [ "${{ matrix.test-subset }}" == "e2e" ]; then
            PATHS="tests/e2e/"
          elif [ "${{ matrix.test-subset }}" == "chaos" ]; then
            PATHS="tests/chaos/"
          else
            PATHS="tests/"
          fi

          # Run mutmut
          mutmut run \
            --paths-to-mutate ${PATHS} \
            --tests-dir tests/ \
            --runner "pytest -x -v --tb=short" \
            --use-coverage \
            --simple-output || true

          # Generate results
          mutmut results > mutation-results.txt
          mutmut html || true

      - name: Generate mutation report
        if: always()
        run: |
          if [ -f mutation-results.txt ]; then
            echo "## üß¨ Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Parse results
            KILLED=$(grep -c "killed" mutation-results.txt || echo "0")
            SURVIVED=$(grep -c "survived" mutation-results.txt || echo "0")
            TIMEOUT=$(grep -c "timeout" mutation-results.txt || echo "0")
            TOTAL=$((KILLED + SURVIVED + TIMEOUT))

            if [ $TOTAL -gt 0 ]; then
              MUTATION_SCORE=$((KILLED * 100 / TOTAL))

              echo "**Test Subset**: ${{ matrix.test-subset }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Count | Percentage |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|------------|" >> $GITHUB_STEP_SUMMARY
              echo "| Killed | ${KILLED} | ${MUTATION_SCORE}% |" >> $GITHUB_STEP_SUMMARY
              echo "| Survived | ${SURVIVED} | $((SURVIVED * 100 / TOTAL))% |" >> $GITHUB_STEP_SUMMARY
              echo "| Timeout | ${TIMEOUT} | $((TIMEOUT * 100 / TOTAL))% |" >> $GITHUB_STEP_SUMMARY
              echo "| **Total** | **${TOTAL}** | **100%** |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              if [ $MUTATION_SCORE -ge 80 ]; then
                echo "‚úÖ **Excellent test quality!** (‚â•80% mutation score)" >> $GITHUB_STEP_SUMMARY
              elif [ $MUTATION_SCORE -ge 60 ]; then
                echo "‚ö†Ô∏è  **Good test quality** (60-79% mutation score)" >> $GITHUB_STEP_SUMMARY
              else
                echo "‚ùå **Tests need improvement** (<60% mutation score)" >> $GITHUB_STEP_SUMMARY
              fi

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Interpretation" >> $GITHUB_STEP_SUMMARY
              echo "- **Killed**: Test caught the mutation (good!)" >> $GITHUB_STEP_SUMMARY
              echo "- **Survived**: Mutation not detected (test gap)" >> $GITHUB_STEP_SUMMARY
              echo "- **Timeout**: Mutation caused infinite loop" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå No mutations generated or tested" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå Mutation testing failed to produce results" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload mutation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report-${{ matrix.test-subset }}
          path: |
            mutation-results.txt
            html/

      - name: Create issue for surviving mutations
        if: steps.mutmut.outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let resultsFile = 'mutation-results.txt';

            if (!fs.existsSync(resultsFile)) {
              console.log('No results file found');
              return;
            }

            let results = fs.readFileSync(resultsFile, 'utf8');
            let survived = (results.match(/survived/g) || []).length;

            if (survived > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Mutation Testing] ${survived} surviving mutations detected`,
                body: `## üß¨ Mutation Testing Alert\n\n` +
                      `**${survived} mutations survived** the test suite.\n\n` +
                      `This means the tests didn't catch these code changes, ` +
                      `indicating potential test gaps.\n\n` +
                      `**Action Required**:\n` +
                      `1. Download the [mutation report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
                      `2. Review surviving mutations\n` +
                      `3. Add tests to kill these mutations\n\n` +
                      `**Test Subset**: ${{ matrix.test-subset }}\n` +
                      `**Run**: ${context.runId}`,
                labels: ['testing', 'quality', 'mutation-testing']
              });
            }
